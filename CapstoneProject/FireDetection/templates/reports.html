{% extends "res_sidebar.html" %}
{% load static %}
{% block title %} True the Fire {% endblock %}

{% block content %}
<header>
    <div class="header-content">
        <div class="header-sb">
            <button type="button" id="sidebar-toggle" class="btn btn-light" onclick="toggleSidebar()">
                <div class="btn-sb">
                    <img src="{% static 'images/sidebar-logo.png' %}" alt="bfp-logo">
                </div>
            </button>
        </div>
        <div class="header-nav">
            <span class="navigation-title">
                <h1>Reports</h1>
            </span>
            <ul class="navigation-list">
                <div class="dropdown">
                    <button class="btn-hotline dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        Hotline
                    </button>
                    <ul class="dropdown-menu drop-hotline" aria-labelledby="dropdownMenu2">
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn-profile dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="icon">
                            <i class="bi bi-person-circle"></i>
                        </span>
                        <div class="drop-user">{{ user.name }}</div>
                    </button>
                    <ul class="dropdown-menu drop-profile" aria-labelledby="dropdownMenu2">
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#terms-condition">Terms & Condition</button></li>
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#change-pass-modal">Change Password</button></li>
                    </ul>
                </div>
            </ul>
        </div>
    </div>
</header>

<main>
    <div class="mn-content-area">
        <div class="reports-box">
            <div class="reports-header">
                <h1>List of Reports</h1>
            </div>
            <div class="reports-body">

                <div class="rb-header">
                    <div class="rbh-left">
                        <div class="rbh-search">
                            <input type="text" id="searchInput" class="search-report" placeholder="Search">
                        </div>
                        
                        <div class="create-button">
                            <!-- <a class="btn-create btn-lg btn" data-bs-toggle="modal" data-bs-target="#create-report-modal"><i class="bi bi-plus-circle px-1"></i>Create Report</a> -->
                            <a class="btn-create btn-lg btn" href="{% url 'create_reports' %}"><i class="bi bi-plus-circle px-1"></i>Create Report</a>
                            
                        </div>
                    </div>
                    
                    <div class="rbh-right">
                        <div class="rbh-filter">
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                  Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                  <li><a class="dropdown-item" href="#">Latest</a></li>
                                  <li><a class="dropdown-item" href="#">Oldest</a></li>
                                  <li><a class="dropdown-item" href="#">Ongoing</a></li>
                                  <li><a class="dropdown-item" href="#">Case Resolved</a></li>
                                </ul>
                              </div>
                        </div>
                    </div>
                </div>

                <div class="rb-table">   
                    <table>
                        <thead>
                            <tr>
                                <th>Report</th>
                                <th>Location</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        
                        <tbody id="reportTable">
                            {% for report in reports %}
                            <tr
                                data-report-id="{{ report.id }}"
                                data-location="{{ report.where }}" 
                                data-date="{{ report.date_reported|date:'Y-m-d' }}"
                                data-time="{{ report.time_reported|time:'H:i' }}"
                                data-fireout="{{ report.time_of_fire_out|time:'H:i' }}"
                                data-owner="{{ report.name_of_owner }}"
                                data-alarm="{{ report.alarm_status }}"
                                data-damages="{{ report.estimated_damages }}"
                                data-establishments="{{ report.no_of_establishments }}"
                                data-casualties="{{ report.no_of_fatality }}" 
                                data-injured="{{ report.no_of_injured }}"
                                data-proof="{{ report.proof }}"
                                data-involved="{{ report.involved }}"
                                data-alarm-declared-by="{{ report.alarm_declared_by }}"
                                data-time-arrival="{{ report.time_of_arrival|time:'H:i' }}"
                                data-time-under-control="{{ report.time_of_fire_under_control|time:'H:i' }}"
                                data-date-under-control="{{ report.date_of_fire_under_control|date:'Y-m-d' }}"
                                data-fire-under-declared-by="{{ report.fire_under_control_declared_by }}"
                                data-time-fire-out="{{ report.time_of_fire_out|time:'H:i' }}"
                                data-date-fire-out="{{ report.date_of_fire_out|date:'Y-m-d' }}"
                                data-fire-out-declared-by="{{ report.fire_out_declared_by }}"
                                data-families-affected="{{ report.no_of_families_affected }}"
                                data-trucks="{{ report.no_of_fire_trucks }}"
                                data-ground-commander="{{ report.ground_commander }}"
                                data-ground-commander-contact="{{ report.commander_contact_number }}"
                                data-safety-officer="{{ report.safety_officer }}"
                                data-safety-officer-contact="{{ report.officer_contact_number }}"
                                data-sender="{{ report.name_of_sender }}"
                                data-sender-contact="{{ report.sender_contact_number }}"
                                
                                data-bs-toggle="modal" 
                                data-bs-target="#report-preview-modal">
                                <td id="report-case">FIR-{{ forloop.counter|stringformat:"02d" }}</td>
                                <td>{{ report.where }}</td>
                                <td>{{ report.date_reported|date:"m/d/Y" }}</td>
                                <td>{{ report.time_reported|time:"h:i A" }}</td>
                                
                                <td>
                                    <h6 id="status-text-{{ report.id }}">{{ report.status }}</h6>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12">No reports available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                                    
                    </table>

                </div>
                <div class="rb-footer">
                    <div class="rb-group">
                        <div class="rb-export">
                            <!-- <div class="input-group mb-3">
                                <span class="input-group-text" id="export-icon" onclick="handleExport()"><i class="bi bi-file-earmark-arrow-down"></i></span>
                                <select class="form-select" id="exportSelect" aria-label="Default select example">
                                    <option value="1">Export to Excel</option>
                                  </select>
                            </div> -->
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="export-icon"><i class="bi bi-file-earmark-arrow-down"></i>
                                </span>
                                <button class="btn btn-excel" value="1" id="exportButton"  onclick="handleExport()">Export to Excel</button>
                            </div>          
                            <div id="noDataMessage" style="display: none; text-align: center; color: red;">No data available</div>
                            <nav aria-label="Page navigation example">
                                <ul class="pagination justify-content-end">
                                    <li class="page-item prev disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item" data-page="1"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item" id="button2" data-page="2"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item" id="button3" data-page="3"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item next">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                            <!-- <button type="button" class="btn btn-lg btn">Export</button> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


      <!-- Modal -->
      
      <!-- Script to Control Modal -->


</main>
{% include "modal_create_report.html" %}
{% include "modal_preview_report.html" %}
{% include "modal_change_password.html" %}
{% include "modal_forgot_success.html" %}
{% include "modal_unsaved_warning.html" %}
{% include "modal_remove_account.html" %}
{% endblock %}

{% block scripts %}
<!--ADD SCRIPTS HERE-->
<script src="{% static 'js/form_controls.js' %}"></script>
<script src="{% static 'js/table_status.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-style@0.8.23/dist/xlsx-style.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/filter.js' %}"></script>
<script src="{% static 'js/preview.js' %}"></script>
<script src="{% static 'js/pagination.js' %}"></script>
<script src="{% static 'js/editing.js' %}"></script>




<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButton = document.querySelector('.edit-form .btn-edit');
        const formInputs = document.querySelectorAll('#report-preview-form .form-control, #report-preview-form .form-select');
        const resolveButton = document.querySelector('.resolve-button');
        const saveButton = document.querySelector('.save-button'); 
        const form = document.getElementById('report-preview-form');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const statusText = document.getElementById('status-text-{{ report.id }}');
        const previewModal = document.getElementById('previewModal'); 
        const closeButton = document.getElementById('close-button'); 
    
        function checkStatusAndDisableEdit() {
            const isCaseClosed = statusText && statusText.textContent.trim() === 'Case Closed';
    
            if (isCaseClosed) {
                editButton.style.pointerEvents = 'none';
                editButton.style.opacity = '0.5';
                resolveButton.disabled = true;
                resolveButton.style.opacity = '0.5';
    
                formInputs.forEach(input => {
                    input.disabled = true;
                    input.readOnly = true;
                });
            }
        }
    
        checkStatusAndDisableEdit();
    
        editButton.addEventListener('click', function() {
            if (!resolveButton.disabled) {
                formInputs.forEach(input => {
                    input.disabled = !input.disabled;
                    input.readOnly = !input.readOnly;
                });
                const icon = editButton.querySelector('i');
                icon.style.color = formInputs[0].disabled ? '' : 'blue';
                saveButton.style.display = formInputs[0].disabled ? 'none' : 'inline-block'; 
            }
        });

        saveButton.addEventListener('click', function(event) {
            event.preventDefault(); 
    
            const formData = new FormData(form);
            formData.append('csrfmiddlewaretoken', csrfToken);
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.new_status === 'Case Closed') {
                        statusText.textContent = 'Case Closed';
                        checkStatusAndDisableEdit();
                    }
                    window.location.href = "/reports/";
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(() => {
                    window.location.href = "/reports/";
                }, 2000); 
            });
        });    
    });
    </script>
    


    <script>

    
isEditing = false; // Track if any report is being edited
    
        function toggleEditButton(reportId, status) {
        const icon = document.getElementById('edit-icon-' + reportId);
        const text = document.getElementById('edit-text-' + reportId);
        const button = document.getElementById('edit-button-' + reportId);
    
        // Disable editing if the status is "Case Closed"
        if (status === "Case Closed") {
            alert("Editing is disabled for reports marked as 'Case Closed'.");
            button.disabled = true; 
            return;
        }
    
        // Toggle editing state
        if (!isEditing) {
            icon.style.display = 'none'; 
            text.textContent = 'Editing'; 
            button.disabled = true;
            button.style.width = 'auto';
            button.style.fontSize = '0.8rem';
            button.style.fontWeight = '500';
            button.style.color = '#ED7027';
            button.style.backgroundColor = 'white';
            button.style.border = '1px solid #ED7027';
    
            isEditing = true; 
        }
    } 

    
    
    document.addEventListener("DOMContentLoaded", () => {
        const reportPreviewModal = document.getElementById('report-preview-modal'); 
    
        reportPreviewModal.addEventListener('hidden.bs.modal', () => {
            if (isEditing) {
                const editButtons = document.querySelectorAll('[id^="edit-button-"]');
                const editIcons = document.querySelectorAll('[id^="edit-icon-"]');
                const editTexts = document.querySelectorAll('[id^="edit-text-"]');
    
                editButtons.forEach((button, index) => {
                    button.disabled = false;
                    button.style.width = '';
                    button.style.fontSize = '';
                    button.style.fontWeight = '';
                    button.style.color = '';
                    button.style.backgroundColor = '';
                    button.style.border = '';
    
                    const icon = editIcons[index];
                    if (icon) icon.style.display = '';
    
                    const text = editTexts[index];
                    if (text) text.textContent = 'Edit'; 
                });
    
                isEditing = false; 
            }
        });
    
        const editButtons = document.querySelectorAll('[id^="edit-button-"]');
        editButtons.forEach(button => {
            const reportId = button.id.split('-').pop(); // Extract the report ID from the button ID
            button.addEventListener('click', () => toggleEditButton(reportId));
        });
    });
    
    
    </script>


{% endblock %}