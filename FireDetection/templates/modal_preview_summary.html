{% load static %}

<div class="modal fade" id="preview-incident-summary" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="mh-left">

                    <h3 class="modal-title" id="modal-title">INCIDENT SUMMARY</h3>
                    <div class="summary-option">
                        <div class="select-filter" id="period-filter">
                            <select class="form-select" aria-label="Default select example" id="period-select" onchange="toggleFilters()">
                                <option value="1" selected>Yearly</option>  <!-- Default selected is Yearly -->
                                <option value="2">Monthly</option>
                            </select>
                        </div>
                        <div class="select-filter" id="month-filter" style="display: none;">  <!-- Initially hidden -->
                            <select class="form-select" aria-label="Default select example">
                                <option value="1" selected>January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="select-filter" id="year-filter" style="display: block;">  <!-- Initially visible -->
                            <select class="form-select" aria-label="Default select example">
                                <option value="2024" selected>2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="group-summary">
                    <div class="indiv-summary">
                        <div>Fire Detected Counts:</div>
                        <span>20</span>
                    </div>

                    <div class="indiv-summary" id="peakFireContainer">
                        <div>Peak Fire Month:</div>
                        <span id="peakFireValue"></span>
                    </div>

                    <div class="indiv-summary" id="mostAffectedContainer">
                        <div>Most Affected Location:</div>
                        <span id="mostAffected"></span>
                    </div>

                    <div class="indiv-summary" id="totalCasualtyContainer">
                        <div>Total Casualties:</div>
                        <span id="totalCasualty"></span>
                    </div>

                    <div class="indiv-summary" id="estimatedDamageContainer"> 
                        <div>Estimated Damages:</div>
                        <span id="estimatedDamage"></span>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/incident_preview_filter.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const periodSelect = document.querySelector("#period-select");
    const monthSelect = document.querySelector("#month-filter select"); 
    const yearSelect = document.querySelector("#year-filter select");
    const monthFilter = document.getElementById("month-filter"); 

    function fetchYearlyData(year) {
        fetch(`/api/peak-report-summary/?year=${year}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("peakFireValue").textContent = data.peak_month || "None";
                document.getElementById("mostAffected").textContent = data.most_affected_location || "None";
                document.getElementById("totalCasualty").textContent = data.total_casualties || "0";
                document.getElementById("estimatedDamage").textContent = data.total_estimated_damages || "0";
            })
            .catch(error => console.error("Error fetching yearly data:", error));
    }

    function fetchMonthlyData(year, month) {
        fetch(`/api/monthly-report-summary/?year=${year}&month=${month}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("peakFireValue").textContent = data.peak_month || "None";
                document.getElementById("mostAffected").textContent = data.most_affected_location || "None";
                document.getElementById("totalCasualty").textContent = data.total_casualties || "0";
                document.getElementById("estimatedDamage").textContent = data.total_estimated_damages || "0";
            })
            .catch(error => console.error("Error fetching monthly data:", error));
    }

    // Event listener for period dropdown
    periodSelect.addEventListener("change", function () {
        const selectedPeriod = this.value; // 1 = Yearly, 2 = Monthly
        if (selectedPeriod === "2") {
            monthFilter.style.display = "block";
            fetchMonthlyData(yearSelect.value, monthSelect.value); // Fetch data for the selected year and month
        } else {

            monthFilter.style.display = "none";
            fetchYearlyData(yearSelect.value);
        }
    });

    yearSelect.addEventListener("change", function () {
        const selectedYear = this.value;
        if (periodSelect.value === "1") {
            fetchYearlyData(selectedYear);
        } else if (periodSelect.value === "2") {
            fetchMonthlyData(selectedYear, monthSelect.value);
        }
    });


    monthSelect.addEventListener("change", function () {
        if (periodSelect.value === "2") {
            fetchMonthlyData(yearSelect.value, this.value);
        }
    });

    function handleTransitionToMonthly() {
        if (periodSelect.value === "2") {
            fetchMonthlyData(yearSelect.value, monthSelect.value); // Ensure correct year and month are fetched
        }
    }


    periodSelect.addEventListener("change", function () {
        if (this.value === "2") {
            handleTransitionToMonthly();
        }
    });


    if (periodSelect.value === "1") {
        fetchYearlyData(yearSelect.value); 
    } else if (periodSelect.value === "2") {
        fetchMonthlyData(yearSelect.value, monthSelect.value); 
    }
});

</script>