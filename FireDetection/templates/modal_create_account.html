<!-- create-account-modal -->
<div class="modal fade" id="add-account-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Create Account</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form action="{% url 'admin_home' %}" method="POST"  id="add-account-form">
                    {% csrf_token %}
                    {{ form.as_p }}

                    <div class="form-row">
                        <div class="form-column">
                            <label for="modal-name" class="form-label">Name<i class="bi bi-asterisk"></i></label>
                            <input type="text" class="form-control" name="name" id="modal-name" placeholder="e.g. Juan Dela Cruz" 
                                   maxlength="60" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-column">
                            <label for="modal-email" class="form-label">Email<i class="bi bi-asterisk"></i></label>
                            <input type="email" class="form-control" name="email" id="modal-email" placeholder="e.g. juandc@gmail.com" maxlength="100" required>
                        </div>
                    </div>                

                    <div class="form-row">
                        <div class="form-column">
                            <label for="modal-role" class="form-label">Role<i class="bi bi-asterisk"></i></label>
                            <select class="form-select" aria-label="Default select example" name="role">
                                <option value="Admin">Admin</option>
                                <option value="Radio Operator">Radio Operator</option>
                                <option value="Responder">Responder</option>
                            </select>                            
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <label for="modal-contact" class="form-label">Contact No.<i class="bi bi-asterisk"></i></label>
                            <input type="text" class="form-control" name="contact_number" id="modal-contact" placeholder="e.g. 09123456789" maxlength="11" required pattern="[0-9]{11}"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                    </div>  

                    <div class="modal-footer">
                        <div class="mf-button">
                            <button class="btn btn-lg px-4 add-account" type="submit">Add Account</button>
                        </div>                   
                    </div>
                </form>

            </div>

        </div>
    </div>
</div>

<script>
    // Utility function to clean the input value based on allowed characters
    const cleanInput = (event, allowedChars) => {
        const input = event.target;
        let value = input.value;

        // Check if the first character is invalid (not a letter or number)
        if (/[^A-Za-z0-9]/.test(value.charAt(0)) && value.length === 1) {
            return; // Don't update if the first character is invalid and it's the only character
        }

        // If the first character is invalid but there are more characters, allow editing
        if (value.length > 1 && /[^A-Za-z0-9]/.test(value.charAt(0))) {
            // Remove the invalid first character and continue processing
            value = value.slice(1);
        }

        // Replace all invalid characters except the first one if it's valid
        input.value = value.replace(new RegExp(`[^${allowedChars}]`, 'g'), '');
    };

    // Generic validation function for name and email fields
    const validateFirstChar = (input, pattern, message) => {
        const firstChar = input.value.charAt(0);
        if (!pattern.test(firstChar)) {
            input.setCustomValidity(message);  // Set error message
            input.value = ''; // Clear the input value if invalid
            return false; // Invalid first character
        }
        input.setCustomValidity(''); // Reset custom validity if valid
        return true; // First character is valid
    };

    // Name field validation
    document.getElementById("modal-name").addEventListener("input", function(event) {
        const input = event.target;
        // Validate first character (must be alphabet or number)
        if (!validateFirstChar(input, /^[A-Za-z]/, "First character must be an alphabet")) {
            return; // Don't proceed if the first character is invalid
        }
        // Clean all non-alphabet characters (allow spaces, dots, commas, hyphens)
        cleanInput(event, 'A-Za-z\\s.,-');
    });

    // Email field validation
    document.getElementById("modal-email").addEventListener('input', function(event) {
        const input = event.target;
        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        
        // Validate first character (must be alphabet)
        if (!validateFirstChar(input, /^[A-Za-z]/, "First character must be an alphabet")) {
            return; // Don't proceed if the first character is invalid
        }

        // Clean spaces from the email input
        input.value = input.value.replace(/\s+/g, '');

        // Clean all invalid characters for email (only allow valid email characters)
        cleanInput(event, 'A-Za-z0-9._%+-@.-');
        
        // Check if the email is valid
        if (!emailPattern.test(input.value)) {
            input.setCustomValidity("Please enter a valid email address.");
        } else {
            input.setCustomValidity(""); // Reset custom validity
        }
    });
</script>





<script>
    document.addEventListener('DOMContentLoaded', function () {
    const addAccountButton = document.querySelector('.add-account'); 
    const nameField = document.getElementById('modal-name');
    const emailField = document.getElementById('modal-email');
    const roleField = document.querySelector('select[name="role"]');
    const contactField = document.getElementById('modal-contact');
    const form = document.getElementById('add-account-form');

    addAccountButton.addEventListener('click', function (event) {
        let valid = true;
        clearErrorMessages(); 

        if (!nameField.value.trim()) {
            showErrorMessage(nameField, 'Name is required.');
            valid = false;
        }

        if (!emailField.value.trim()) {
            showErrorMessage(emailField, 'Email is required.');
            valid = false;
        } else if (!validateEmail(emailField.value.trim())) {
            showErrorMessage(emailField, 'Invalid email format. (example@gmail.com)');
            valid = false;
        }

        if (!roleField.value) {
            showErrorMessage(roleField, 'Role is required.');
            valid = false;
        }

        if (!contactField.value.trim()) {
            showErrorMessage(contactField, 'Contact number is required.');
            valid = false;
        } else if (!/^\d{11}$/.test(contactField.value.trim())) {
            showErrorMessage(contactField, 'Contact number must be 11 digits.');
            valid = false;
        }

        if (!valid) {
            event.preventDefault();
        }
    });

    function showErrorMessage(field, message) {
        const errorElement = document.createElement('small');
        errorElement.textContent = message;
        errorElement.style.color = 'red';
        errorElement.style.fontSize = '0.75rem';
        errorElement.className = 'error-message';
        field.parentNode.appendChild(errorElement); 
        field.classList.add('is-invalid');
    }

    function clearErrorMessages() {
        const invalidFields = document.querySelectorAll('.is-invalid');
        invalidFields.forEach(function (field) {
            field.classList.remove('is-invalid');
        });

        const errorMessages = document.querySelectorAll('.error-message');
        errorMessages.forEach(function (msg) {
            msg.remove();
        });
    }

    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
});

</script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
    const emailField = document.getElementById('modal-email');
    const phoneField = document.getElementById('modal-contact');
    const form = document.getElementById('add-account-form');

    form.addEventListener('submit', function (event) {
        event.preventDefault();
        const email = emailField.value.trim();
        const phone_number = phoneField.value.trim();

        removeError(emailField);
        removeError(phoneField);

        if (!email) {
            showError(emailField, 'Email is required.');
            return;
        }

        if (!phone_number) {
            showError(phoneField, 'Phone number is required.');
            return;
        }

        fetch(`/check-email/?email=${encodeURIComponent(email)}&phone_number=${encodeURIComponent(phone_number)}`)
            .then(response => response.json())
            .then(data => {
                if (data.email_exists) {
                    showError(emailField, 'This email is already registered.');
                }

                if (data.phone_exists) {
                    showError(phoneField, 'This phone number is already registered.');
                }

                if (!data.email_exists && !data.phone_exists) {
                    form.submit();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(emailField, 'An error occurred while validating the email. Please try again.');
                showError(phoneField, 'An error occurred while validating the phone number. Please try again.');
            });
    });

    function showError(field, message) {
        let existingError = field.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }

        const errorElement = document.createElement('small');
        errorElement.className = 'error-message'; 
        errorElement.textContent = message;
        errorElement.style.color = 'red';
        errorElement.style.fontSize = '0.8rem';
        field.parentNode.appendChild(errorElement);
        field.classList.add('is-invalid');
    }

    function removeError(field) {
        let existingError = field.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }
        field.classList.remove('is-invalid');
    }
});


</script>