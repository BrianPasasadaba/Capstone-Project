{% extends "res_sidebar.html" %}
{% load static %}
{% block title %} True the Fire {% endblock %}

{% block content %}
<header>
    <div class="header-content">
        <div class="header-sb">
            <div class="ham-menu" id="sidebar-toggle" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="header-nav">
            <span class="navigation-title">
                <h1>Reports</h1>
            </span>
            <ul class="navigation-list">
                <div class="dropdown">
                    <button class="btn-hotline dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        Hotline
                    </button>
                    <ul class="dropdown-menu drop-hotline" aria-labelledby="dropdownMenu2">
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn-profile dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="icon">
                            <i class="bi bi-person-circle"></i>
                        </span>
                        <div class="drop-user">{{ user.name }}</div>
                    </button>
                    <ul class="dropdown-menu drop-profile" aria-labelledby="dropdownMenu2">
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#terms-condition-modal">Terms & Condition</button></li>
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#change-pass-modal">Change Password</button></li>
                    </ul>
                </div>
            </ul>
        </div>
    </div>
</header>

<main>
    <div class="mn-content-area">
        <div class="reports-box">
            <div class="reports-header">
                <h1>List of Reports</h1>
            </div>
            <div class="reports-body">

                <div class="rb-header">
                    <div class="rbh-left">

                        <div class="rbh-search">
                            <input type="text" id="searchInput" class="search-report" placeholder="Search" maxlength="30">
                            <ul id="suggestionsBox" class="dropdown-menu"></ul>
                        </div>
                        
                        <div class="create-button">
                            <!-- <a class="btn-create btn-lg btn" data-bs-toggle="modal" data-bs-target="#create-report-modal"><i class="bi bi-plus-circle px-1"></i>Create Report</a> -->
                            <a class="btn-create btn-lg btn" href="{% url 'create_reports' %}"><i class="bi bi-plus-circle px-1"></i>Create Report</a>
                            
                        </div>
                    </div>
                    
                    <div class="rbh-right">
                        <div class="rbh-filter">
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                  Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                  <li><a class="dropdown-item" href="#">Latest</a></li>
                                  <li><a class="dropdown-item" href="#">Oldest</a></li>
                                  <li><a class="dropdown-item" href="#">Ongoing</a></li>
                                  <li><a class="dropdown-item" href="#">Case Resolved</a></li>
                                </ul>
                              </div>
                        </div>
                    </div>
                </div>

                <div class="rb-table">   
                    <table>
                        <thead>
                            <tr  data-bs-toggle="modal" >
                                <th>Report</th>
                                <th>Location</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        
                        <tbody id="reportTable">
                            {% for report in reports %}
                            <tr
                                data-report-id="{{ report.id|default:0 }}"
                                data-status="{{ report.status|default:'None' }}"
                                data-location="{{ report.where|default:'None' }}" 
                                data-date="{{ report.date_reported|date:'Y-m-d'|default:'None' }}"
                                data-time="{{ report.time_reported|time:'H:i'|default:'None' }}"
                                data-fireout="{{ report.time_of_fire_out|time:'H:i'|default:'None' }}"
                                data-owner="{{ report.name_of_owner|default:'None' }}"
                                data-alarm="{{ report.alarm_status|default:'None' }}"
                                data-damages="{{ report.estimated_damages|default:0 }}"
                                data-establishments="{{ report.no_of_establishments|default:0 }}"
                                data-casualties="{{ report.no_of_fatality|default:0 }}" 
                                data-injured="{{ report.no_of_injured|default:0 }}"
                                data-proof="{{ report.proof|default:'None' }}"
                                data-involved="{{ report.involved|default:'None' }}"
                                data-alarm-declared-by="{{ report.alarm_declared_by|default:'None' }}"
                                data-time-arrival="{{ report.time_of_arrival|time:'H:i'|default:'None' }}"
                                data-time-under-control="{{ report.time_of_fire_under_control|time:'H:i'|default:'None' }}"
                                data-date-under-control="{{ report.date_of_fire_under_control|date:'Y-m-d'|default:'None' }}"
                                data-fire-under-declared-by="{{ report.fire_under_control_declared_by|default:'None' }}"
                                data-time-fire-out="{{ report.time_of_fire_out|time:'H:i'|default:'None' }}"
                                data-date-fire-out="{{ report.date_of_fire_out|date:'Y-m-d'|default:'None' }}"
                                data-fire-out-declared-by="{{ report.fire_out_declared_by|default:'None' }}"
                                data-families-affected="{{ report.no_of_families_affected|default:0 }}"
                                data-trucks="{{ report.no_of_fire_trucks|default:0 }}"
                                data-ground-commander="{{ report.ground_commander|default:'None' }}"
                                data-ground-commander-contact="{{ report.commander_contact_number|default:'None' }}"
                                data-safety-officer="{{ report.safety_officer|default:'None' }}"
                                data-safety-officer-contact="{{ report.officer_contact_number|default:'None' }}"
                                data-sender="{{ report.name_of_sender|default:'None' }}"
                                data-sender-contact="{{ report.sender_contact_number|default:'None' }}"
                                data-team="{{ report.team|default:'None' }}" 
                                
                                data-bs-toggle="modal" 
                                data-bs-target="#report-preview-modal">
                                <td>{{ report.fir_number|default:'None' }}</td>
                                <td>{{ report.where|default:'None' }}</td>
                                <td>{{ report.date_reported|date:"m/d/Y"|default:'None' }}</td>
                                <td>{{ report.time_reported|time:"h:i A"|default:'None' }}</td>
                                <td>
                                    <h6 id="status-text-{{ report.id }}">{{ report.status|default:'None' }}</h6>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5">No reports available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tr id="noResultsMessage" style="display: none;">
                            <td colspan="5" style="color: red; text-align: center;">No results found. Try again.</td>
                        </tr>      
                        <tr id="noFoundFilter" style="display: none;">
                            <td colspan="5" style="color: red; text-align: center;">No Data to Display.</td>
                        </tr>                     
                    </table>
                    

                </div>
                <div class="rb-footer">
                    <div class="rb-group">
                        <div class="rb-export">
                            <!-- <div class="input-group mb-3">
                                <span class="input-group-text" id="export-icon" onclick="handleExport()"><i class="bi bi-file-earmark-arrow-down"></i></span>
                                <select class="form-select" id="exportSelect" aria-label="Default select example">
                                    <option value="1">Export to Excel</option>
                                  </select>
                            </div> -->
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="export-icon"><i class="bi bi-file-earmark-arrow-down"></i>
                                </span>
                                <button class="btn btn-excel" value="1" id="exportButton"  onclick="handleExport()">Export to Excel</button>
                            </div>          
                            
                            <div id="noDataMessage" style="display: none; text-align: center; font-size: 16px;">
                                No data available.
                            </div>
                            

                            <nav aria-label="Page navigation example">
                                <ul class="pagination justify-content-end">
                                    <li class="page-item prev disabled">
                                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                    </li>
                                    <li class="page-item" data-page="1"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item" id="button2" data-page="2"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item" id="button3" data-page="3"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item next">
                                        <a class="page-link" href="#">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                            <!-- <button type="button" class="btn btn-lg btn">Export</button> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


      <!-- Modal -->
      
      <!-- Script to Control Modal -->


</main>

{% include "modal_create_report.html" %}
{% include "modal_preview_report.html" %}
{% include "modal_change_password.html" %}
{% include "modal_forgot_success.html" %}
{% include "modal_unsaved_warning.html" %}
{% include "modal_remove_account.html" %}
{% include "modal_copied_success.html" %}
{% include "modal_terms_condi.html" %}

{% endblock %}

{% block scripts %}
<!--ADD SCRIPTS HERE-->
<script src="{% static 'js/form_controls.js' %}"></script>
<script src="{% static 'js/table_status.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-style@0.8.23/dist/xlsx-style.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/filter.js' %}"></script>
<script src="{% static 'js/preview.js' %}"></script>
<script src="{% static 'js/pagination.js' %}"></script>
<script src="{% static 'js/editing.js' %}"></script>
<script src="{% static 'js/dropdown_filter.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
const searchInput = document.getElementById('searchInput');
const suggestionsBox = document.getElementById('suggestionsBox');


const validInputPattern = /^[A-Za-z0-9]*$/;
searchInput.addEventListener('input', function (e) {
const inputValue = e.target.value;
if (!validInputPattern.test(inputValue)) {
e.target.value = inputValue.slice(0, -1);
}

updateSuggestions(inputValue);
});

function updateSuggestions(query) {
suggestionsBox.innerHTML = ''; 
if (query.length > 0) {
const suggestionItem = document.createElement('li');
suggestionItem.classList.add('dropdown-item');
suggestionItem.textContent = query; 
suggestionsBox.appendChild(suggestionItem);
suggestionsBox.style.display = 'block';
} else {
suggestionsBox.style.display = 'none'; 
}
}
document.addEventListener('click', function (event) {
if (!searchInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
suggestionsBox.style.display = 'none';
}
});
});

</script>

<script>
    
    document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const reportTable = document.getElementById('reportTable');
    const noResultsMessage = document.getElementById('noResultsMessage');

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.toLowerCase();
        let rows = reportTable.getElementsByTagName('tr');
        let hasVisibleRows = false;

        Array.from(rows).forEach(row => {
            const cells = Array.from(row.getElementsByTagName('td'));
            const rowText = cells.map(cell => cell.textContent.toLowerCase()).join(' ');

            if (rowText.includes(query)) {
                row.style.display = '';
                hasVisibleRows = true;
            } else {
                row.style.display = 'none'; 
            }
        });

        if (hasVisibleRows) {
            noResultsMessage.style.display = 'none';
        } else {
            noResultsMessage.style.display = 'table-row';
        }
    });
});

document.getElementById('searchInput').addEventListener('input', function (e) {
    // Replace invalid characters with an empty string
    this.value = this.value.replace(/[^a-zA-Z0-9\-\/_]/g, '');
});

</script>
    
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const reportTable = document.getElementById('reportTable');
    const hiddenReportIdInput = document.getElementById('report-id');
    const modal = document.getElementById('report-preview-modal');

    reportTable.addEventListener('click', function (event) {
        const clickedRow = event.target.closest('tr');
        if (clickedRow && clickedRow.dataset.reportId) {
            const reportId = clickedRow.dataset.reportId;
            console.log('Clicked Report ID:', reportId);

            hiddenReportIdInput.value = reportId;

            console.log('Hidden Input Value Set:', hiddenReportIdInput.value);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        } else {
            console.error('No valid report ID found for the clicked row.');
        }
    });
});


    document.addEventListener('DOMContentLoaded', function () {
    const editButton = document.querySelector('.edit-form .btn-edit');
    const formInputs = document.querySelectorAll('#report-preview-form .form-control, #report-preview-form .form-select');
    const resolveButton = document.querySelector('.resolve-button');
    const saveButton = document.querySelector('.save-button'); 
    const form = document.getElementById('report-preview-form');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const statusText = document.getElementById('status-text-{{ report.id }}');
    const previewModal = document.getElementById('previewModal'); 
    const closeButton = document.getElementById('close-button'); 

    function checkStatusAndDisableEdit() {
    const isCaseClosed = statusText && statusText.textContent.trim() === 'Case Closed';

    if (isCaseClosed) {
        // Hide the Edit Button
        editButton.style.display = 'none';

        // Disable and make the Resolve Button semi-transparent
        resolveButton.disabled = true;
        resolveButton.style.opacity = '0.5';

        // Disable all form inputs
        formInputs.forEach(input => {
            input.disabled = true;
            input.readOnly = true;
        });
    }
}



checkStatusAndDisableEdit();
// Add event listener to the edit button
editButton.addEventListener('click', function() {
    if (!resolveButton.disabled) {
        formInputs.forEach(input => {
            input.disabled = !input.disabled;
            input.readOnly = !input.readOnly;
        });

        const icon = editButton.querySelector('i');
        const text = editButton.querySelector('span'); 

        const isEditable = !formInputs[0].disabled; // Check if form inputs are editable

        // Fields to toggle visibility for (the original fields you mentioned)
        const originalFields = [
            document.getElementById('involved'),
            document.getElementById('alarm-dec'),
            document.getElementById('funder-dec'),
            document.getElementById('fout-dec'),
            document.getElementById('ground'),
            document.getElementById('safety'),
            document.getElementById('sender')
        ];

        // Search fields to toggle visibility for (ending with -search)
        const searchFields = [
            document.getElementById('involved-search'),
            document.getElementById('alarm-dec-search'),
            document.getElementById('funder-dec-search'),
            document.getElementById('fout-dec-search'),
            document.getElementById('ground-search'),
            document.getElementById('safety-search'),
            document.getElementById('sender-search')
        ];

        // Check if all original fields and search fields are present in the DOM
        originalFields.forEach((field, index) => {
            if (field === null) {
                console.error(`Original field with ID ${originalFields[index].id} not found.`);
            }
        });
        searchFields.forEach((field, index) => {
            if (field === null) {
                console.error(`Search field with ID ${searchFields[index].id} not found.`);
            }
        });

        // When editing, pass the current value of original fields to the search fields
        originalFields.forEach((originalField, index) => {
            if (originalField && searchFields[index]) {
                searchFields[index].value = originalField.value; // Set search field value to original field's value
            }
        });

        // Toggle visibility of search fields and original fields
        searchFields.forEach(searchField => {
            if (searchField) {
                searchField.style.display = isEditable ? 'block' : 'none'; // Show or hide search fields based on edit mode
            }
        });

        originalFields.forEach(originalField => {
            if (originalField) {
                originalField.style.display = isEditable ? 'none' : 'block'; // Hide or show original fields based on edit mode
            }
        });

        if (isEditable) {
            icon.style.display = 'none'; 
            text.textContent = 'Editing';

            // Change appearance of edit button
            editButton.style.backgroundColor = 'white';
            editButton.style.borderColor = '#ED7027';
            editButton.style.color = '#ED7027';
            text.style.fontWeight = '500'; // Set text weight to 500
            editButton.disabled = true; // Disable the button
        } else {
            icon.style.display = '';
            text.textContent = 'Edit';
        }

        saveButton.style.display = isEditable ? 'inline-block' : 'none';
    }
});





// Define the function to clear error messages
function clearErrorMessages() {
    const errorMessages = document.querySelectorAll('.is-invalid');
    errorMessages.forEach(function (field) {
        field.classList.remove('is-invalid');
    });

    const errorText = document.querySelectorAll('small');
    errorText.forEach(function (msg) {
        msg.remove();
    });
}

// Define the function to show error messages
function showErrorMessage(field, message) {
    const errorElement = document.createElement('small');
    errorElement.textContent = message;
    errorElement.style.color = 'red';
    errorElement.style.fontSize = '0.8rem';
    field.parentNode.appendChild(errorElement);
    field.classList.add('is-invalid');
}

// Add event listener for the save button
saveButton.addEventListener('click', function (event) {
    event.preventDefault();

    const locationField = document.getElementById('loc');
    const detectField = document.getElementById('detect');
    const dateField = document.getElementById('date');
    const ownerField = document.getElementById('owner');
    const alarmDecField = document.getElementById('alarm-dec');
    const funderDecField = document.getElementById('funder-dec');
    const foutDecField = document.getElementById('fout-dec');

    let valid = true;
    clearErrorMessages();

    // Validate required fields
    if (!locationField.value.trim()) {
        showErrorMessage(locationField, 'Location is required.');
        valid = false;
    }

    if (!detectField.value) {
        showErrorMessage(detectField, 'Time Reported is required.');
        valid = false;
    }

    if (!dateField.value) {
        showErrorMessage(dateField, 'Date is required.');
        valid = false;
    }

    if (!valid) {
        return;
    }

    const reportId = document.getElementById('report-id').value;

    if (!reportId) {
        console.error('Report ID is missing!');
        alert('Report ID is missing. Please try again.');
        return;
    }

    const formData = new FormData(form);
    formData.append('csrfmiddlewaretoken', csrfToken);

    // Handle numeric fields: Default to 0 if empty
    const numericFields = ['damage', 'fatality', 'injured', 'affected', 'establishment', 'truck'];
    numericFields.forEach(field => {
        const fieldElement = document.getElementById(field);
        if (!fieldElement.value.trim()) {
            formData.set(field, '0'); // Default to "0"
        }
    });

    const optionalFields = ['owner', 'alarm-dec', 'funder-dec', 'fout-dec'];
    optionalFields.forEach(field => {
        const fieldElement = document.getElementById(field);
        if (!fieldElement.value.trim()) {
            formData.set(field, 'None'); // Default to "None"
        }
    });

    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }

    fetch(`/update-report/${reportId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken,
        },
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    console.error('Server error:', err.message);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${err.message}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                console.log('Report updated successfully.');
                window.location.href = "/reports/";
            } else {
                console.error('Error updating report:', data.message);
                alert('Error updating report: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('An error occurred. Please try again.');
        });
});


    });
    </script>
    





{% endblock %}