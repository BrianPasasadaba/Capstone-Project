{% extends "res_sidebar.html" %}
{% load static %}
{% block title %} True the Fire {% endblock %}

{% block content %}
<header>
    <style>
    span.dt-column-order {
        display: none !important;
    }

    table.dataTable thead > tr > th.dt-ordering-asc {
        padding: 0px !important; 
    }

    table.dataTable thead > tr > th.dt-ordering-desc{
        padding: 0px !important;
    }
    </style>

    <div class="header-content">
        <div class="header-sb" >
            <div class="ham-menu" id="sidebar-toggle" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="header-nav">
            <span class="navigation-title">
                <h1>Accounts</h1>
            </span>
            <ul class="navigation-list">
                <div class="dropdown">
                    <button class="btn-hotline dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        Hotline
                    </button>
                    <ul class="dropdown-menu drop-hotline" aria-labelledby="dropdownMenu2">
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn-profile dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="icon">
                            <i class="bi bi-person-circle"></i>
                        </span>
                        <div class="drop-user">{{ user.name }}</div>
                    </button>

                    <ul class="dropdown-menu drop-profile" aria-labelledby="dropdownMenu2">
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#terms-condition-modal">Terms & Condition</button></li>
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#change-pass-modal">Change Password</button></li>
                    </ul>

                </div>
            </ul>
        </div>
    </div>
</header>


<main>
    <div class="mn-content-area">
        <div class="accounts-box">
            <div class="accounts-header">
                <h1>List of Accounts</h1>
            </div>
            <div class="accounts-body">
                <div class="ab-header">
                    <div class="abh-search">
                        <input type="text" id="accountSearchInput" class="search-report" placeholder="Search">
                    </div>
                    <div class="abh-filter">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                              Filter
                            </button>
                            <ul class="dropdown-menu dropdown-filter" aria-labelledby="dropdownMenuButton1" id="dropdown-filter-acc">
                              <li><a class="dropdown-item" href="#">Verified</a></li>
                              <li><a class="dropdown-item" href="#">Unverified</a></li>
                            </ul>
                          </div>
                    </div>
                </div>
                <div class="ab-table">

                    <table id="accountsTable">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="accountTable">
                            {% for account in accounts %}
                            <tr 
                            data-account-id="{{ account.id }}" 
                            data-name="{{ account.name }}" 
                            data-email="{{ account.email }}" 
                            data-role="{{ account.get_role_display }}" 
                            data-contact="{{ account.contact_number }}" 
                            data-status="{{ account.verified }}">
                            <td>
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input account-checkbox" 
                                            type="checkbox" 
                                            value="{{ account.email }}" 
                                            id="flexCheckDefault-{{ account.id }}">
                                        <label class="form-check-label" for="flexCheckDefault-{{ account.id }}"></label>
                                    </div>
                                </td>
                                <td>{{ account.name }}</td>
                                <td>{{ account.get_role_display }}</td>
                                <td>{{ account.contact_number }}</td>
                                <td>{{ account.email }}</td>
                                <td>
                                    <div>
                                        <h6>
                                            {% if account.verified %}
                                            <span>Verified</span>
                                            {% else %}
                                            <span>Unverified</span>
                                            {% endif %}
                                        </h6>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6">No accounts available.</td>
                            </tr>
                            {% endfor %}
 
                        </tbody>
                        <tr id="noFoundFilter" style="display: none;">
                            <td colspan="5" style="color: red; text-align: center;">No Data to Display.</td>
                        </tr>  
                    </table>         

                </div>
                <div class="ab-buttons">
                    <div class="ab-add">
                        <button type="button" class="btn btn-lg btn" data-bs-toggle="modal" data-bs-target="#add-account-modal">Add</button>
                        <button 
                            type="button" 
                            class="btn btn-lg btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#remove-account-modal" 
                            id="removeButton"  disabled>
                            Remove
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
                    
                    
</main>

<!-- Include the modal -->
{% include "modal_create_account.html" %}
{% include "modal_remove_account.html" %}
{% include "modal_change_password.html" %}
{% include "modal_forgot_success.html" %}
{% include "modal_terms_condi.html" %}
{% include "modal_addacc_success.html" %}
{% include "modal_preview_account.html" %}
{% include "modal_editacc_success.html" %}

{% endblock %}

{% block scripts %}
<!-- ADD SCRIPTS HERE -->
<script src="{% static 'js/form_controls.js' %}"></script>
<script src="{% static 'js/table_status.js' %}"></script>
<!-- <script src="{% static 'js/filter.js' %}"></script> -->
<script src="{% static 'js/dropdown_filter.js' %}"></script>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        const accountForm = document.getElementById('prev-account-form');
        const saveButton = accountForm.querySelector('.add-account');
        const accountIdInput = document.getElementById('account-id'); // The hidden input for account ID
        const accountTable = document.getElementById('accountTable'); // The table containing account rows
        const editModal = new bootstrap.Modal(document.getElementById('prev-account-modal')); // Instance of the edit modal
        const successModalElement = document.getElementById('editacc-success-modal'); // Success modal element
        const successModal = new bootstrap.Modal(successModalElement, {
            backdrop: 'static', 
            keyboard: false 
        }); 

        const okButton = document.getElementById('modal-ok-button');
        okButton.removeEventListener('click', handleOkButtonClick); // Ensure there are no pre-existing listeners
        if (localStorage.getItem('showSuccessModal') === 'true') {
            successModal.show();
            localStorage.removeItem('showSuccessModal'); // Clear the flag after showing the modal

            okButton.addEventListener('click', handleOkButtonClick);
        }

        accountTable.addEventListener('click', function (event) {
            const row = event.target.closest('tr[data-account-id]'); // Find the closest row with account data

            if (row) {
                const accountId = row.getAttribute('data-account-id');

                accountIdInput.value = accountId;

                // Populate other fields in the form (if needed)
                document.getElementById('prev-name').value = row.getAttribute('data-name');
                document.getElementById('prev-email').value = row.getAttribute('data-email');
                document.getElementById('prev-role').value = row.getAttribute('data-role');
                document.getElementById('prev-contact').value = row.getAttribute('data-contact');

                // Show the edit modal
                editModal.show();
            }
        });

        accountForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(accountForm);

            fetch('/update-account/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'), // Include CSRF token
                },
                body: formData,
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    saveButton.disabled = true;

                    editModal.hide();

                    localStorage.setItem('showSuccessModal', 'true');

                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function handleOkButtonClick() {
            console.log("OK button clicked. Redirecting to /admin_home/...");
            window.location.href = '/admin_home/';
        }
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
    
        // Initialize DataTables with custom configuration
        const accountsTable = new DataTable('#accountsTable', {
            responsive: false,
            searching: true,  // Enable searching
            lengthChange: false,
            ordering: true,
            paging: true,
            pagingType: 'full_numbers',
            pageLength: 10,
            info: false, 
            columnDefs: [
                { className: "dt-head-center", targets: "_all" },
                { className: "dt-body-center", targets: "_all"},
                { targets: "_all", orderable: false}


            ],
            language: {
                emptyTable: "No data available",
                zeroRecords: "No matching records found",
                paginate: {
                    next: 'Next',
                    previous: 'Previous'  
                  }
            },
            layout: {
                topEnd: null,
                bottomEnd: {
                    paging: {
                        buttons: 3
                    }
                }
            }
        });

        // Custom filtering functionality
        const dropdownItems = document.querySelectorAll('.dropdown-filter .dropdown-item');
        const searchInput = document.getElementById('accountSearchInput');

        function applyFilter(filterCriteria) {
            accountsTable.search('').columns().search('').draw(); // Clear existing filters

            $.fn.dataTable.ext.search = [];
        
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                const status = $(accountsTable.row(dataIndex).node()).find('td:eq(5) span').text().trim();
                return filterCriteria === 'All' || status === filterCriteria;
            });
        
            accountsTable.draw();
        }
        

        // Event listener for dropdown filter
        dropdownItems.forEach(item => {
            item.addEventListener('click', function (e) {
                const filterCriteria = e.target.textContent.trim();
                
                // Update active state in dropdown
                dropdownItems.forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
    
                applyFilter(filterCriteria);
            });
        });



        // Event listener for search input
        searchInput.addEventListener('input', function () {
            accountsTable.search(this.value).draw();
        });

        accountsTable.draw(); // Draw the table
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const accountTable = document.getElementById('accountTable');
    const nameInput = document.getElementById('prev-name');
    const emailInput = document.getElementById('prev-email');
    const roleSelect = document.getElementById('prev-role');
    const contactInput = document.getElementById('prev-contact');

    // Prevent checkbox clicks from propagating to the row
    accountTable.addEventListener('click', function (event) {
        if (event.target.classList.contains('form-check-input')) {
            console.log('Checkbox clicked. Preventing modal from opening.');
            event.stopPropagation(); // Stop the event from propagating to the row
            return; // Stop further execution
        }

        const row = event.target.closest('tr[data-account-id]');
        if (row) {
            // Fetch data from the row's data attributes
            const accountId = row.getAttribute('data-account-id');
            const name = row.getAttribute('data-name');
            const email = row.getAttribute('data-email');
            const role = row.getAttribute('data-role');
            const contact = row.getAttribute('data-contact');
            const status = row.getAttribute('data-status');

            console.log('Selected Account:', { accountId, name, email, role, contact, status });

            // Populate the modal fields
            nameInput.value = name;
            emailInput.value = email;
            roleSelect.value = role;
            contactInput.value = contact;

            // Enable/disable fields or buttons if needed (e.g., based on status)
            if (status === 'true') {
                console.log('Account is verified');
            }

            // Open the modal
            const modal = new bootstrap.Modal(document.getElementById('prev-account-modal'));
            modal.show();
        }
    });
});


</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Check if the account_added context variable is passed and true
        {% if account_added %}
            const successModal = new bootstrap.Modal(document.getElementById('addacc-success-modal'));
            successModal.show();
        {% endif %}
    
        // Handle the OK button click to redirect
        const modalOkButton = document.getElementById('modal-ok-button');
        modalOkButton.addEventListener('click', function() {
            window.location.href = '/admin_home/'; // Redirect to the admin home page
        });
    });
    </script>



<script>
    let selectedEmails = []; 

    document.addEventListener("DOMContentLoaded", () => {
    const removeButton = document.getElementById("removeButton");
    const checkboxes = document.querySelectorAll(".account-checkbox");

    removeButton.disabled = true;
    function toggleRemoveButton() {
        const anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        removeButton.disabled = !anyChecked;
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener("change", toggleRemoveButton);
    });

    removeButton.addEventListener("click", function () {
        selectedEmails = []; 
        document.querySelectorAll('#accountTable .form-check-input:checked').forEach((checkbox) => {
            selectedEmails.push(checkbox.value);
        });

        if (selectedEmails.length === 0) {
            alert('Please select at least one account to remove.');
            return;
        }

        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('remove-account-modal'));
        modal.show();
    });

    document.getElementById('confirmRemoveButton').addEventListener("click", function () {
        if (selectedEmails.length === 0) {
            return;
        }

        fetch('/remove-accounts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() 
            },
            body: JSON.stringify({ emails: selectedEmails })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('remove-account-modal'));
                    modal.hide();

                    selectedEmails.forEach(email => {
                        const row = [...document.querySelectorAll('#accountTable tr')].find(tr =>
                            tr.querySelector('td:nth-child(4)')?.textContent.trim() === email
                        );
                        if (row) row.remove();
                    });

                    window.location.href = '/admin_home/';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing accounts.');
            });
    });

    document.querySelector('.btn-cancel').addEventListener("click", function () {
        window.location.href = '/admin_home/';
    });

    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return null;
    }
});


</script>



{% endblock %}
