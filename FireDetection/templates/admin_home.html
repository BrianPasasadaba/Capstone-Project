{% extends "res_sidebar.html" %}
{% load static %}
{% block title %} True the Fire {% endblock %}

{% block content %}
<header>
    <div class="header-content">
        <div class="header-sb" >
            <div class="ham-menu" id="sidebar-toggle" onclick="toggleSidebar()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="header-nav">
            <span class="navigation-title">
                <h1>Accounts</h1>
            </span>
            <ul class="navigation-list">
                <div class="dropdown">
                    <button class="btn-hotline dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        Hotline
                    </button>
                    <ul class="dropdown-menu drop-hotline" aria-labelledby="dropdownMenu2">
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                        <li class="dropdown-item">(610) 888-1111</li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="btn-profile dropdown-toggle" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="icon">
                            <i class="bi bi-person-circle"></i>
                        </span>
                        <div class="drop-user">{{ user.name }}</div>
                    </button>

                    <ul class="dropdown-menu drop-profile" aria-labelledby="dropdownMenu2">
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#terms-condition-modal">Terms & Condition</button></li>
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#change-pass-modal">Change Password</button></li>
                    </ul>

                </div>
            </ul>
        </div>
    </div>
</header>


<main>
    <div class="mn-content-area">
        <div class="accounts-box">
            <div class="accounts-header">
                <h1>List of Accounts</h1>
            </div>
            <div class="accounts-body">
                <div class="ab-header">
                    <div class="abh-search">
                        <input type="text" id="accountSearchInput" class="search-report" placeholder="Search">
                    </div>
                    <div class="abh-filter">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                              Filter
                            </button>
                            <ul class="dropdown-menu dropdown-filter" aria-labelledby="dropdownMenuButton1" id="dropdown-filter">
                              <li><a class="dropdown-item" href="#">Verified</a></li>
                              <li><a class="dropdown-item" href="#">Unverified</a></li>
                            </ul>
                          </div>
                    </div>
                </div>
                <div class="ab-table">

                    <table>
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="accountTable">
                            {% for account in accounts %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input account-checkbox" 
                                            type="checkbox" 
                                            value="{{ account.email }}" 
                                            id="flexCheckDefault-{{ account.id }}">
                                        <label class="form-check-label" for="flexCheckDefault-{{ account.id }}"></label>
                                    </div>
                                </td>
                                <td>{{ account.name }}</td>
                                <td>{{ account.get_role_display }}</td>
                                <td>{{ account.contact_number }}</td>
                                <td>{{ account.email }}</td>
                                <td>
                                    <div>
                                        <h6>
                                            {% if account.verified %}
                                            <span>Verified</span>
                                            {% else %}
                                            <span>Unverified</span>
                                            {% endif %}
                                        </h6>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6">No accounts available.</td>
                            </tr>
                            {% endfor %}
 
                        </tbody>
                        <tr id="noFoundFilter" style="display: none;">
                            <td colspan="5" style="color: red; text-align: center;">No Data to Display.</td>
                        </tr>  
                    </table>         

                </div>
                <div class="ab-buttons">
                    <div class="ab-add">
                        <button type="button" class="btn btn-lg btn" data-bs-toggle="modal" data-bs-target="#add-account-modal">Add</button>
                        <button 
                            type="button" 
                            class="btn btn-lg btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#remove-account-modal" 
                            id="removeButton"  disabled>
                            Remove
                        </button>
                    </div>

                    <div class="ab-pagination">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination justify-content-end">
                                <li class="page-item prev disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                </li>
                                <li class="page-item" data-page="1"><a class="page-link" href="#">1</a></li>
                                <li class="page-item" id="button2" data-page="2"><a class="page-link" href="#">2</a></li>
                                <li class="page-item" id="button3" data-page="3"><a class="page-link" href="#">3</a></li>
                                <li class="page-item next">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            </ul>                            
                        </nav>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
                    
                    
</main>

<!-- Include the modal -->
{% include "modal_create_account.html" %}
{% include "modal_remove_account.html" %}
{% include "modal_change_password.html" %}
{% include "modal_forgot_success.html" %}
{% include "modal_terms_condi.html" %}
{% endblock %}

{% block scripts %}
<!-- ADD SCRIPTS HERE -->
<script src="{% static 'js/form_controls.js' %}"></script>
<script src="{% static 'js/table_status.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="{% static 'js/filter.js' %}"></script>
<script src="{% static 'js/pagination.js' %}"></script>
<script src="{% static 'js/dropdown_filter.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tableBody = document.getElementById('accountTable');
        const rows = Array.from(tableBody.querySelectorAll('tr'));

        rows.sort((rowA, rowB) => {
            const nameA = rowA.cells[1].textContent.trim().toLowerCase();
            const nameB = rowB.cells[1].textContent.trim().toLowerCase();

            return nameA.localeCompare(nameB);
        });

        rows.forEach(row => tableBody.appendChild(row));
    });
</script>



<script>
    document.addEventListener('DOMContentLoaded', function () {
    const filterItems = document.querySelectorAll('.dropdown-filter .dropdown-item'); 
    const tableRows = document.querySelectorAll('#accountTable tr'); 
    filterItems.forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault(); 
            const filterCriteria = e.target.textContent.trim(); 

            tableRows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(6) h6 span'); 
                if (statusCell) {
                    const rowStatus = statusCell.textContent.trim(); 

                    if (filterCriteria === rowStatus) {
                        row.style.display = ''; 
                    } else {
                        row.style.display = 'none'; 
                    }
                }
            });
        });
    });
});

document.getElementById('accountSearchInput').addEventListener('input', function (e) {
    // Replace invalid characters with an empty string
    this.value = this.value.replace(/[^a-zA-Z0-9.\-\/_@]/g, '');
});
</script>
<script>
    let selectedEmails = []; 

    document.addEventListener("DOMContentLoaded", () => {
    const removeButton = document.getElementById("removeButton");
    const checkboxes = document.querySelectorAll(".account-checkbox");

    removeButton.disabled = true;
    function toggleRemoveButton() {
        const anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        removeButton.disabled = !anyChecked;
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener("change", toggleRemoveButton);
    });

    removeButton.addEventListener("click", function () {
        selectedEmails = []; 
        document.querySelectorAll('#accountTable .form-check-input:checked').forEach((checkbox) => {
            selectedEmails.push(checkbox.value);
        });

        if (selectedEmails.length === 0) {
            alert('Please select at least one account to remove.');
            return;
        }

        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('remove-account-modal'));
        modal.show();
    });

    document.getElementById('confirmRemoveButton').addEventListener("click", function () {
        if (selectedEmails.length === 0) {
            return;
        }

        fetch('/remove-accounts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() 
            },
            body: JSON.stringify({ emails: selectedEmails })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('remove-account-modal'));
                    modal.hide();

                    selectedEmails.forEach(email => {
                        const row = [...document.querySelectorAll('#accountTable tr')].find(tr =>
                            tr.querySelector('td:nth-child(4)')?.textContent.trim() === email
                        );
                        if (row) row.remove();
                    });

                    window.location.href = '/admin_home/';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing accounts.');
            });
    });

    document.querySelector('.btn-cancel').addEventListener("click", function () {
        window.location.href = '/admin_home/';
    });

    function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return null;
    }
});


</script>



{% endblock %}
