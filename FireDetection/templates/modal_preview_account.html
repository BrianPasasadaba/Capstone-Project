<!-- create-account-modal -->
<div class="modal fade" id="prev-account-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Account</h3>
                <div class="edit-form">
                    <button class="btn btn-edit" id="edit-button">
                        <i class="bi bi-pencil-square"></i>
                        <span id="edit-text">Edit</span>
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close" id="closeButton"></button>
            </div>
            <div class="modal-body">

                <form action="{% url 'update_account'  %}" method="POST"  id="prev-account-form" novalidate>
                    <input type="hidden" id="account-id" name="account_id" value="">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-name" class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" id="prev-name" placeholder="e.g. Juan Dela Cruz" 
                                   maxlength="60" required>
                            <span class="warning-text" id="name-warning" style="display:none; color:red;">Name is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-email" class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="prev-email" placeholder="e.g. juandc@gmail.com" maxlength="100" required>
                            <span class="warning-text" id="email-warning" style="display:none; color:red;">Email is required</span>
                        </div>
                    </div>                

                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-role" class="form-label">Role</label>
                            <select class="form-select" aria-label="Default select example" name="role" id="prev-role">
                                <option value="Admin">Admin</option>
                                <option value="Radio Operator">Radio Operator</option>
                                <option value="Responder">Responder</option>
                            </select>                            
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-contact" class="form-label">Contact No.</label>
                            <input type="text" class="form-control" name="contact_number" id="prev-contact" placeholder="e.g. 09123456789" maxlength="11" required pattern="[0-9]{11}"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            <span class="warning-text" id="contact-warning" style="display:none; color:red;">Contact number is required</span>
                        </div>
                    </div>  

                    <div class="modal-footer">
                        <div class="mf-button">
                            <button class="btn btn-lg px-4 add-account" type="submit" disabled>Save</button>
                        </div>                   
                    </div>
                </form>

            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const accountForm = document.getElementById('prev-account-form');
        const saveButton = accountForm.querySelector('.add-account');
        const accountIdInput = document.getElementById('account-id');
        const accountTable = document.getElementById('accountTable');
        const editModal = new bootstrap.Modal(document.getElementById('prev-account-modal'));
        const successModalElement = document.getElementById('editacc-success-modal');
        const successModal = new bootstrap.Modal(successModalElement, {
            backdrop: 'static',
            keyboard: false,
        });
        const okButton = document.getElementById('modal-ok-button');

        // Show success modal if triggered
        if (localStorage.getItem('showSuccessModal') === 'true') {
            successModal.show();
            localStorage.removeItem('showSuccessModal');
            okButton.addEventListener('click', () => {
                window.location.href = '/admin_home/';
            });
        }

        // Handle account table row click
        accountTable.addEventListener('click', function (event) {
            const row = event.target.closest('tr[data-account-id]');
            if (row) {
                accountIdInput.value = row.getAttribute('data-account-id');
                document.getElementById('prev-name').value = row.getAttribute('data-name');
                document.getElementById('prev-email').value = row.getAttribute('data-email');
                document.getElementById('prev-role').value = row.getAttribute('data-role');
                document.getElementById('prev-contact').value = row.getAttribute('data-contact');
                editModal.show();
            }
        });

        // Form submission handler
        accountForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            // Field references and error containers
            const nameField = document.getElementById('prev-name');
            const emailField = document.getElementById('prev-email');
            const contactField = document.getElementById('prev-contact');
            const roleField = document.getElementById('prev-role');
            const nameWarning = document.getElementById('name-warning');
            const emailWarning = document.getElementById('email-warning');
            const contactWarning = document.getElementById('contact-warning');
            const contactPattern = /^[0-9]{11}$/;

            let hasErrors = false;

            // Clear previous error styles and messages
            [nameField, emailField, contactField, roleField].forEach((field) => {
                field.style.border = '';
            });
            [nameWarning, emailWarning, contactWarning].forEach((warning) => {
                warning.style.display = 'none';
            });

            // Validate fields
            if (!nameField.value.trim()) {
                nameField.style.border = '1px solid red';
                nameWarning.style.display = 'inline';
                hasErrors = true;
            }

            if (!emailField.value.trim()) {
                emailField.style.border = '1px solid red';
                emailWarning.textContent = 'Email is required.';
                emailWarning.style.display = 'inline';
                hasErrors = true;
            }

            if (!contactField.value.trim() || !contactPattern.test(contactField.value.trim())) {
                contactField.style.border = '1px solid red';
                contactWarning.textContent =
                    'Phone number must be 11 digits.';
                contactWarning.style.display = 'inline';
                hasErrors = true;
            }

            if (!roleField.value.trim()) {
                roleField.style.border = '1px solid red';
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            // Check for email and contact uniqueness
            try {
                const email = emailField.value.trim();
                const phoneNumber = contactField.value.trim();
                const accountId = accountIdInput.value;

                const response = await fetch(
                    `/check-email/?email=${encodeURIComponent(email)}&phone_number=${encodeURIComponent(phoneNumber)}&account_id=${accountId}`
                );
                const data = await response.json();

                if (data.email_exists) {
                    emailField.style.border = '1px solid red';
                    emailWarning.textContent = 'This email is already registered.';
                    emailWarning.style.display = 'inline';
                    hasErrors = true;
                }

                if (data.phone_exists) {
                    contactField.style.border = '1px solid red';
                    contactWarning.textContent = 'This phone number is already registered.';
                    contactWarning.style.display = 'inline';
                    hasErrors = true;
                }

                // Stop submission if errors exist
                if (hasErrors) {
                    return;
                }

                // Submit the form
                const formData = new FormData(accountForm);
                const saveResponse = await fetch('/update-account/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    },
                    body: formData,
                });

                if (saveResponse.ok) {
                    localStorage.setItem('showSuccessModal', 'true');
                    editModal.hide();
                    window.location.reload();
                } else {
                    console.error('Server error during form submission.');
                }
            } catch (error) {
                console.error('Error validating form:', error);
            }
        });
    });
</script>

        
        
        
        
        

<script>
    document.getElementById('closeButton').addEventListener('click', function() {
        location.reload(); // This will refresh the page
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButton = document.getElementById('edit-button');
        const form = document.getElementById('prev-account-form');
        const formFields = form.querySelectorAll('input, select, button');
        const icon = editButton.querySelector('i'); // Get the icon element
        const editText = document.getElementById('edit-text'); // Get the edit text

        // Initially disable all fields
        formFields.forEach(field => {
            if (field.type !== 'submit') {
                field.disabled = true;
            }
        });

        // Toggle editing mode on "Edit" button click
        editButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default behavior of button
            const isEditable = formFields[0].disabled; // Check if fields are currently disabled
            
            formFields.forEach(field => {
                if (field.type !== 'submit') {
                    field.disabled = !isEditable; // Toggle the disabled attribute
                }
            });

            // Change button text and handle icon visibility
            if (isEditable) {
                editText.textContent = 'Editing'; // Change text to 'Editing'
                icon.style.display = 'none'; // Hide the icon
                editButton.disabled = true; // Disable the edit button while editing
            } else {
                editText.textContent = 'Edit'; // Change text back to 'Edit'
                icon.style.display = 'inline'; // Show the icon again
                editButton.disabled = false; // Re-enable the edit button after editing
            }

            // Enable/disable the submit button
            const submitButton = form.querySelector('.add-account');
            submitButton.disabled = !isEditable;
        });
    });
</script>


