<!-- create-account-modal -->
<div class="modal fade" id="prev-account-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Account</h3>
                <div class="edit-form">
                    <button class="btn btn-edit" id="edit-button">
                        <i class="bi bi-pencil-square"></i>
                        <span id="edit-text">Edit</span>
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Close" id="closeButton"></button>
            </div>
            <div class="modal-body">

                <form action="{% url 'update_account'  %}" method="POST"  id="prev-account-form" novalidate>
                    <input type="hidden" id="account-id" name="account_id" value="">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-name" class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" id="prev-name" placeholder="e.g. Juan Dela Cruz" 
                                   maxlength="60" required>
                            <span class="warning-text" id="name-warning" style="display:none; color:red;">Name is required</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-email" class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="prev-email" placeholder="e.g. juandc@gmail.com" maxlength="100" required>
                            <span class="warning-text" id="email-warning" style="display:none; color:red;">Email is required</span>
                        </div>
                    </div>                

                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-role" class="form-label">Role</label>
                            <select class="form-select" aria-label="Default select example" name="role" id="prev-role">
                                <option value="Admin">Admin</option>
                                <option value="Radio Operator">Radio Operator</option>
                                <option value="Responder">Responder</option>
                            </select>                            
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <label for="prev-contact" class="form-label">Contact No.</label>
                            <input type="text" class="form-control" name="contact_number" id="prev-contact" placeholder="e.g. 09123456789" maxlength="11" required pattern="[0-9]{11}"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                            <span class="warning-text" id="contact-warning" style="display:none; color:red;">Contact number is required</span>
                        </div>
                    </div>  

                    <div class="modal-footer">
                        <div class="mf-button">
                            <button class="btn btn-lg px-4 add-account" type="submit" disabled>Save</button>
                        </div>                   
                    </div>
                </form>

            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const accountForm = document.getElementById('prev-account-form');
    const saveButton = accountForm.querySelector('.add-account');
    const accountIdInput = document.getElementById('account-id'); // The hidden input for account ID
    const accountTable = document.getElementById('accountTable'); // The table containing account rows
    const editModal = new bootstrap.Modal(document.getElementById('prev-account-modal')); // Instance of the edit modal
    const successModalElement = document.getElementById('editacc-success-modal'); // Success modal element
    const successModal = new bootstrap.Modal(successModalElement, {
        backdrop: 'static', 
        keyboard: false 
    });

    const okButton = document.getElementById('modal-ok-button');
    okButton.removeEventListener('click', handleOkButtonClick); // Ensure there are no pre-existing listeners
    if (localStorage.getItem('showSuccessModal') === 'true') {
        successModal.show();
        localStorage.removeItem('showSuccessModal'); // Clear the flag after showing the modal

        okButton.addEventListener('click', handleOkButtonClick);
    }

    accountTable.addEventListener('click', function (event) {
        const row = event.target.closest('tr[data-account-id]'); // Find the closest row with account data

        if (row) {
            const accountId = row.getAttribute('data-account-id');

            accountIdInput.value = accountId;

            // Populate other fields in the form (if needed)
            document.getElementById('prev-name').value = row.getAttribute('data-name');
            document.getElementById('prev-email').value = row.getAttribute('data-email');
            document.getElementById('prev-role').value = row.getAttribute('data-role');
            document.getElementById('prev-contact').value = row.getAttribute('data-contact');

            // Show the edit modal
            editModal.show();
        }
    });

    // Add event listener to check email existence on change
    const emailField = document.getElementById('prev-email');
    emailField.addEventListener('blur', async function () {
        const email = emailField.value.trim();
        const accountId = accountIdInput.value;

        if (email) {
            try {
                const response = await fetch(`/check-email-exists/?email=${email}&account_id=${accountId}`);
                const data = await response.json();
                
                if (data.email_exists) {
                    emailField.style.border = '1px solid red';
                    document.getElementById('email-warning').style.display = 'inline';
                } else {
                    emailField.style.border = '';
                    document.getElementById('email-warning').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking email:', error);
            }
        }
    });

    accountForm.addEventListener('submit', async function (event) {
        event.preventDefault(); // Prevent the default form submission

        // Perform client-side validation
        const nameField = document.getElementById('prev-name');
        const contactField = document.getElementById('prev-contact');
        const roleField = document.getElementById('prev-role');
        const nameWarning = document.getElementById('name-warning');
        const contactWarning = document.getElementById('contact-warning');
        const emailWarning = document.getElementById('email-warning');

        let hasErrors = false;

        // Clear previous error styles and messages
        [nameField, emailField, contactField, roleField].forEach(field => {
            field.style.border = '';
        });
        [nameWarning, emailWarning, contactWarning].forEach(warning => {
            warning.style.display = 'none';
        });

        // Validate Name
        if (!nameField.value.trim()) {
            nameField.style.border = '1px solid red';
            nameWarning.style.display = 'inline'; // Show the warning message
            hasErrors = true;
        }

        // Validate Email (already done via blur)
        if (!emailField.value.trim()) {
            emailField.style.border = '1px solid red';
            emailWarning.style.display = 'inline'; // Show the warning message
            hasErrors = true;
        }

        // Validate Contact (example: should be numeric and 10-15 characters)
        const contactPattern = /^[0-9]{10,15}$/;
        if (!contactField.value.trim() || !contactPattern.test(contactField.value.trim())) {
            contactField.style.border = '1px solid red';
            contactWarning.style.display = 'inline'; // Show the warning message
            hasErrors = true;
        }

        // Validate Role
        if (!roleField.value.trim()) {
            roleField.style.border = '1px solid red';
            hasErrors = true;
        }

        // If there are validation errors, do not proceed
        if (hasErrors) {
            console.error('Validation failed. Fix the errors before submitting.');
            return;
        }

        // Perform asynchronous validation for email and contact uniqueness
        try {
            const formData = new FormData(accountForm);

            const response = await fetch('/update-account/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'), // Include CSRF token
                },
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                if (data.errors) {
                    console.error('Server validation failed:', data.errors);
                    data.errors.forEach(error => {
                        const field = document.getElementById(error.field);
                        const warning = document.getElementById(`${error.field}-warning`);
                        if (field) {
                            field.style.border = '1px solid red';
                        }
                        if (warning) {
                            warning.style.display = 'inline';
                        }
                    });
                    return;
                }

                saveButton.disabled = true;

                editModal.hide();

                localStorage.setItem('showSuccessModal', 'true');

                window.location.reload();
            } else {
                throw new Error('Network response was not ok');
            }
        } catch (error) {
            console.error('Error submitting the form:', error);
        }
    });

    function handleOkButtonClick() {
        console.log("OK button clicked. Redirecting to /admin_home/...");
        window.location.href = '/admin_home/';
    }
});

</script>
        
        
        
        
        

<script>
    document.getElementById('closeButton').addEventListener('click', function() {
        location.reload(); // This will refresh the page
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButton = document.getElementById('edit-button');
        const form = document.getElementById('prev-account-form');
        const formFields = form.querySelectorAll('input, select, button');
        const icon = editButton.querySelector('i'); // Get the icon element
        const editText = document.getElementById('edit-text'); // Get the edit text

        // Initially disable all fields
        formFields.forEach(field => {
            if (field.type !== 'submit') {
                field.disabled = true;
            }
        });

        // Toggle editing mode on "Edit" button click
        editButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default behavior of button
            const isEditable = formFields[0].disabled; // Check if fields are currently disabled
            
            formFields.forEach(field => {
                if (field.type !== 'submit') {
                    field.disabled = !isEditable; // Toggle the disabled attribute
                }
            });

            // Change button text and handle icon visibility
            if (isEditable) {
                editText.textContent = 'Editing'; // Change text to 'Editing'
                icon.style.display = 'none'; // Hide the icon
                editButton.disabled = true; // Disable the edit button while editing
            } else {
                editText.textContent = 'Edit'; // Change text back to 'Edit'
                icon.style.display = 'inline'; // Show the icon again
                editButton.disabled = false; // Re-enable the edit button after editing
            }

            // Enable/disable the submit button
            const submitButton = form.querySelector('.add-account');
            submitButton.disabled = !isEditable;
        });
    });
</script>


