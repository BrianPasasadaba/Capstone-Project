{% load static %}
{% load active_link_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'styles/app_style.css' %}">
    <!-- Bootstrap CSS -->
    <link defer href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link defer href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" charset="UTF-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script defer src="{% static 'js/sidebar_pop.js' %}"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>{% block title %} True the Fire {% endblock %}</title>
    {% block mycss %} {% endblock mycss %}
</head>

<body>
    <!--CSRF-TOKEN-->
    <form>
        {% csrf_token %}
    </form>


<!--POP UP ALERT-->
    <!-- Modal -->
<!--
    {% if request.user.role == "Radio Operator" %}

<div class="modal fade" id="pop-up-modal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><svg xmlns="http://www.w3.org/2000/svg" width="44" height="43" viewBox="0 0 44 43" fill="none">
            <path d="M8.97897 26.875V25.0834H7.1873V21.5H8.97897V19.7084H12.5623V26.875H8.97897ZM34.0623 21.5V19.7084H30.479V26.875H34.0623V25.0834H35.854V21.5H34.0623ZM32.2706 10.75H28.4365C27.7915 8.24171 25.8206 6.27087 23.3123 5.62587V3.58337H19.729V5.62587C17.2206 6.27087 15.2498 8.24171 14.6048 10.75H10.7706V14.3334H32.2706V10.75ZM32.2706 39.4167H10.7706C10.7706 37.4459 12.3831 35.8334 14.354 35.8334V16.125H28.6873V35.8334C29.6377 35.8334 30.5491 36.2109 31.2211 36.8829C31.8931 37.5549 32.2706 38.4664 32.2706 39.4167ZM17.9373 23.2917C17.9373 24.2421 18.3148 25.1535 18.9868 25.8255C19.6588 26.4975 20.5703 26.875 21.5206 26.875C22.471 26.875 23.3824 26.4975 24.0544 25.8255C24.7264 25.1535 25.104 24.2421 25.104 23.2917C25.104 21.303 23.5094 19.7084 21.5206 19.7084C19.5319 19.7084 17.9373 21.3209 17.9373 23.2917Z" fill="#ED7027"/>

          </svg>Alert!</h3>
        </div>
        <div class="modal-body">
            <h4>The System Detected a Fire!</i></h4>
            <div class="group-report">
                <div class="indiv-detail">
                    <div>Proof</div>
                    <span class="proof-image">
                        <img id="detect-proof" class="img-fluid" style="max-width: 500px;" alt="Proof Image">
                    </span>
                </div>
                <div class="indiv-detail">
                    <div class="label-detail">
                        <div>Date</div>
                        <div>Location</div>
                    </div>
                    <div class="info-detail">
                        <span>October 22, 2024</span>
                        <span>Barangay Caingin</span>
                    </div>
                </div>
                <div class="indiv-detail">
                    <div class="label-detail">
                        <div>Time</div>
                    </div>
                    <div class="info-detail">
                        <span>1:11 PM</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="mf-button">
                <button type="button" class="btn" id="btn-dismiss" data-bs-dismiss="modal" aria-label="Close">Dismiss</button>
                <button type="button" class="btn" id="btn-popreport" data-bs-dismiss="modal" aria-label="Close">Report</button>
            </div>
        </div>
      </div>
    </div>
</div>

{% endif %}

{% if user_role == "Radio Operator" %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var myModal = new bootstrap.Modal(document.getElementById('pop-up-modal'));
        myModal.show();
    });
</script>
{% endif %}

-->

<!--TOAST START-->
   <!-- Toast container -->
{% if request.user.role == "Radio Operator" %}
<div class="toast-container">
    <!--
    <div class="toast" id="toast-1" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">A Fire has been Detected!</strong>
          <small class="text-muted">just now</small>
        </div>
        <div class="toast-body">
          <button class="btn tb-btn" data-bs-toggle="modal" data-bs-target="#pop-up-modal" data-bs-dismiss="toast" aria-label="Close">View Details <i class="bi bi-arrow-right-circle"></i></button>
        </div>
      </div>
      
      <div class="toast" id="toast-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">A Fire has been Detected!</strong>
          <small class="text-muted">2 seconds ago</small>
        </div>
        <div class="toast-body">
          <button class="btn tb-btn" data-bs-toggle="modal" data-bs-target="#pop-up-modal" data-bs-dismiss="toast" aria-label="Close">View Details <i class="bi bi-arrow-right-circle"></i></button>
        </div>
      </div>
      
      <div class="toast" id="toast-3" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">A Fire has been Detected!</strong>
          <small class="text-muted">3 seconds ago</small>
        </div>
        <div class="toast-body">
          <button class="btn tb-btn" data-bs-toggle="modal" data-bs-target="#pop-up-modal" data-bs-dismiss="toast" aria-label="Close">View Details <i class="bi bi-arrow-right-circle"></i></button>
        </div>
      </div>
        -->
</div>

<div class="modal-container">

</div>
{% endif %}


<!--TOAST END-->



<!-- FOR CONTENT THAT NEEDS TO BE SHOWN ON EVERY HTML USING SIDEBAR, ADD CODE ABOVE THE CONTENT BLOCK -->
{%block content%}
<!-- DO NOT ADD CONTENT HERE -->
{%endblock%}

<aside id="sidebar">
    <div class="sidebar-content">
        <div class="sidebar">
            <div class="sb-header">
                <div class="sbheader-logo"> 
                    <img src="{% static 'images/sidebar-logo.png' %}" alt="sb-logo">
                </div>
                <div class="sbheader-text">
                    <h2>BFP</h2>
                </div>
            </div>

            <div class="sb-body">
                <nav class="nav">
                    {% if request.user.is_authenticated and request.user.is_active and request.user.is_staff %}
                    <a class="nav-link {% active_link 'admin_home' 'custom-class' %} {% if request.resolver_match.url_name == 'admin_home' %}disabled-link{% endif %}" href="{% url 'admin_home' %}"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-custom-class="custom-tooltip"
                    data-bs-title="Accounts">
                        <div class="nav-con">
                            <span class="icon">
                                <i class="bi bi-person-fill-gear"></i>
                            </span>
                            <span class="description">Accounts</span>
                        </div>
                    </a>
                    {% endif %}
                    <a class="nav-link {% active_link 'analytics' 'custom-class' %} {% if request.resolver_match.url_name == 'analytics' %}disabled-link{% endif %}" href="{% url 'analytics' %}"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-custom-class="custom-tooltip"
                    data-bs-title="Analytics">
                        <div class="nav-con">
                            <span class="icon">
                                <i class="bi bi-columns-gap"></i>
                            </span>
                            <span class="description">Analytics</span>
                        </div>
                    </a>
                    <a class="nav-link {% active_link 'reports' 'custom-class' %} {% if request.resolver_match.url_name == 'reports' %}disabled-link{% endif %}" href="{% url 'reports' %}"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-custom-class="custom-tooltip"
                    data-bs-title="Reports">
                        <div class="nav-con">
                            <span class="icon">
                                <i class="bi bi-clipboard2-data"></i>
                            </span>
                            <span class="description">Reports</span>
                        </div>
                    </a>
                    <a class="nav-link {% active_link 'faq' 'custom-class' %} {% if request.resolver_match.url_name == 'faq' %}disabled-link{% endif %}" href="{% url 'faq' %}"
                    data-bs-toggle="tooltip" data-bs-placement="right"
                    data-bs-custom-class="custom-tooltip"
                    data-bs-title="FAQ">
                        <div class="nav-con">
                            <span class="icon">
                                <i class="bi bi-question-circle"></i>
                            </span>
                            <span class="description">FAQ</span>
                        </div>
                    </a>
                    <a class="nav-link" data-bs-toggle="modal" data-bs-target="#logout-modal">
                        <div class="nav-con">
                            <span class="icon">
                                <i class="bi bi-box-arrow-left"></i>
                            </span>
                            <span class="description">Logout</span>
                        </div>
                    </a>
                </nav>
            </div>
        </div>
    </div>

</aside>

    {% include "modal_dismiss_confirm.html" %}
    {% include "modal_log_out.html" %}
    <!-- SVG Background -->
    <div class="top-divider">
        <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="auto" viewBox="0 0 1280 308" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M1280 0H0C0.622448 0.989264 1.25128 1.97802 1.88558 2.96628C12.1646 18.9896 24.3198 34.7798 42.5916 49.7217C55.5614 60.3364 69.5221 70.6025 85.945 80.1973C98.7745 87.69 112.822 94.5393 127.987 100.849C144.515 107.727 161.596 114.197 179.764 119.858C214.187 130.592 250.783 137.246 288.546 141.598C300.517 142.977 312.52 143.809 324.524 144.641C330.292 145.041 336.061 145.44 341.827 145.901C348.885 146.465 355.958 146.741 363.016 147.016C364.18 147.061 365.344 147.106 366.507 147.153C375.654 147.522 384.795 147.824 393.927 148.125C395.662 148.182 397.397 148.24 399.132 148.297C405.075 148.498 411.013 148.691 416.953 148.883L416.969 148.883C423.738 149.102 430.508 149.322 437.285 149.554C439.077 149.616 440.868 149.677 442.659 149.739L442.66 149.739C451.333 150.036 460 150.333 468.686 150.714C473.31 150.915 477.945 151.164 482.578 151.414L482.581 151.414L482.583 151.414C489.894 151.807 497.203 152.2 504.469 152.404C515.256 152.706 526.066 153.523 536.844 154.339C537.791 154.41 538.737 154.482 539.684 154.553C550.6 155.376 561.537 156.581 572.454 158.279C586.962 160.538 601.224 163.171 615.315 166.248C642.715 172.224 668.349 180.089 693.367 188.589C712.895 195.227 731.922 202.241 750.521 209.596C761.001 213.738 771.57 217.818 782.138 221.898L782.142 221.9L782.146 221.901C792.921 226.062 803.696 230.222 814.376 234.447C837.628 243.652 861.263 252.583 885.313 261.201C897.148 265.446 909.323 269.44 921.532 273.39C934.275 277.515 947.293 281.368 960.68 284.866C974.846 288.563 989.44 291.534 1004.09 294.412C1016.12 296.775 1028.17 299.109 1040.53 300.67C1045.13 300.907 1049.64 301.623 1054.15 302.34C1058.37 303.01 1062.6 303.681 1066.9 303.96C1068.74 304.079 1070.57 304.182 1072.41 304.285C1078.37 304.621 1084.33 304.956 1090.3 305.825C1095.44 306.283 1100.59 306.597 1105.75 306.9C1121.07 307.789 1136.17 307.982 1150.96 307.344C1181.1 306.045 1210.24 303.273 1237.75 298.381C1252.68 295.721 1266.97 292.514 1280 288.307V0Z" fill="#0E1E4B"/>
          </svg>
    </div>
    <div class="custom-shape-divider-bottom-1724214088">
        <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" class="shape-fill"></path>
            <path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" opacity=".5" class="shape-fill"></path>
            <path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" class="shape-fill"></path>
        </svg>
    </div>

    <!-- FOR SCRIPTS THAT NEED TO BE ADDED ON EVERY PAGE USING BASE, ADD CODE ABOVE THE SCRIPT BLOCK -->
<!-- MODAL -->
    <script>
        $(document).ready(function() {
            $('#btn-dismiss').click(function() {
                $('#pop-up-modal').modal('hide'); // Hide the initial modal
                $('#dismiss-modal').modal('show'); // Show the confirmation modal
            });

            // Handler for the Cancel button in the confirm dismiss modal
            $('.btn-discancel').click(function() {
                $('#dismiss-modal').modal('hide'); // Hide the confirmation modal
                $('#pop-up-modal').modal('show'); // Re-show the initial modal
            });

            // Handler for the Confirm button in the confirm dismiss modal
            $('.btn-disconfirm').click(function() {
                $('#dismiss-modal').modal('hide'); // Close the confirmation modal
                // Optionally, you can perform additional actions here if needed when confirmation is complete
            });
        });
        </script>
<!-- TOAST -->

<!--      <script>
            // If you want to ensure the toast does not auto-dismiss, use this JavaScript to handle it explicitly.
            document.addEventListener('DOMContentLoaded', function () {
                const toastElements = Array.from(document.querySelectorAll('.toast'));
                toastElements.forEach(toastElement => {
                    const toastInstance = new bootstrap.Toast(toastElement, {
                        autohide: false // Disable auto-hide
                    });
                    toastInstance.show();
                });
            });
        </script>
-->

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
</script>

<!-- DESKTOP UPDATE -->
<script>
document.addEventListener('DOMContentLoaded', async function(){
    class DesktopUpdates {
        constructor() {
            this.eventSource = new EventSource('{% url "event-stream" %}');
            this.toastCounter = 0;
            
            this.eventSource.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                await this.handleUpdate(data);
            };
            
            this.eventSource.onerror = (error) => {
                console.error('EventSource failed:', error);
            };

            this.addGlobalEventListeners();
        }

        addGlobalEventListeners() {
            // Delegate event listeners to handle dynamically created buttons
            document.addEventListener('click', async (event) => {
                // Dismiss button in main modal
                if (event.target.closest('.dismiss-btn')) {
                    const modal = event.target.closest('.modal');
                    const reportId = modal.getAttribute('data-report-id');
                    const modalId = modal.getAttribute('id');
                    
                    // Show dismiss confirmation modal
                    const dismissModal = document.getElementById('dismiss-modal');
                    if (dismissModal) {
                        const bootstrapDismissModal = new bootstrap.Modal(dismissModal);
                        
                        // Store the current report ID on the confirm button
                        const confirmButton = dismissModal.querySelector('.btn-disconfirm');
                        confirmButton.setAttribute('data-report-id', reportId);
                        confirmButton.setAttribute('data-main-modal-id', modalId);
                        
                        bootstrapDismissModal.show();
                    }
                }

                // Confirm dismiss button
                if (event.target.closest('.btn-disconfirm')) {
                    const reportId = event.target.getAttribute('data-report-id');
                    const mainModalId = event.target.getAttribute('data-main-modal-id');
                    
                    try {
                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        const response = await fetch(`/update-temp-report-status/${reportId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'Dismissed' }),
                            credentials: 'same-origin'
                        });

                        if (response.ok) {
                            // Close both modals
                            const dismissModal = document.getElementById('dismiss-modal');
                            const mainModal = document.getElementById(mainModalId);
                            
                            // Manually remove backdrops
                            const removeBackdrop = () => {
                                const backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(backdrop => backdrop.remove());
                                document.body.classList.remove('modal-open');
                            };
                            
                            if (dismissModal) {
                                const dismissModalInstance = bootstrap.Modal.getInstance(dismissModal);
                                dismissModalInstance.hide();
                                
                                // Use event listener to ensure backdrop is removed
                                dismissModal.addEventListener('hidden.bs.modal', removeBackdrop, { once: true });
                            }
                            
                            if (mainModal) {
                                const mainModalInstance = bootstrap.Modal.getInstance(mainModal);
                                mainModalInstance.hide();
                                
                                // Use event listener to ensure backdrop is removed
                                mainModal.addEventListener('hidden.bs.modal', removeBackdrop, { once: true });
                            }

                            // Fallback to manual backdrop removal
                            removeBackdrop();

                            // Remove corresponding toast
                            const toast = document.querySelector(`.toast[data-report-id="${reportId}"]`);
                            if (toast) {
                                bootstrap.Toast.getInstance(toast).hide();
                                toast.remove();
                            }
                        } else {
                            console.error('Failed to update report status');
                        }
                    } catch (error) {
                        console.error('Error updating report status:', error);
                    }
                }

                // Report button
                if (event.target.closest('.report-btn')) {
                    const modal = event.target.closest('.modal');
                    const reportId = modal.getAttribute('data-report-id');
                    const modalId = modal.getAttribute('id');
                    
                    try {
                        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        const response = await fetch(`/transfer_report/${reportId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin'
                        });

                        if (response.ok) {
                            // Update report status to Filed
                            await fetch(`/update-temp-report-status/${reportId}/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrftoken,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ status: 'Filed' }),
                                credentials: 'same-origin'
                            });

                            // Manually remove backdrops
                            const removeBackdrop = () => {
                                const backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(backdrop => backdrop.remove());
                                document.body.classList.remove('modal-open');
                            };


                            // Close the modal
                            const mainModal = document.getElementById(modalId);
                            if (mainModal) {
                                const mainModalInstance = bootstrap.Modal.getInstance(mainModal);
                                mainModalInstance.hide();
                                
                                // Use event listener to ensure backdrop is removed
                                mainModal.addEventListener('hidden.bs.modal', removeBackdrop, { once: true });
                            }

                            // Fallback to manual backdrop removal
                            removeBackdrop();

                            // Remove corresponding toast
                            const toast = document.querySelector(`.toast[data-report-id="${reportId}"]`);
                            if (toast) {
                                bootstrap.Toast.getInstance(toast).hide();
                                toast.remove();
                            }
                        } else {
                            console.error('Failed to transfer report');
                        }
                    } catch (error) {
                        console.error('Error transferring report:', error);
                    }
                }

                // Cancel dismiss button (return to previous modal)
                if (event.target.closest('.btn-discancel')) {
                    const dismissModal = document.getElementById('dismiss-modal');
                    if (dismissModal) {
                        const dismissModalInstance = bootstrap.Modal.getInstance(dismissModal);
                        dismissModalInstance.hide();
                        
                        // Manually remove backdrops
                        const removeBackdrop = () => {
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            backdrops.forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                        };
                        
                        // Use event listener to ensure backdrop is removed
                        dismissModal.addEventListener('hidden.bs.modal', removeBackdrop, { once: true });
                        
                        // Fallback to manual backdrop removal
                        removeBackdrop();
                    }
                }
            });
        }
    
        async handleUpdate(data) {
            if (data.type === 'new_temp_report') {
                try {
                    const response = await fetch(`/get-temp-report-details/${data.report_id}/`);
                    const reportDetails = await response.json();
                    
                    if (reportDetails) {
                        this.createToastAndModal(reportDetails);
                    }
                } catch (error) {
                    console.error('Error fetching report details:', error);
                }
            } else if (data.type === 'updated_record') {
                try {
                    const response = await fetch(`/get-temp-report-details/${data.report_id}/`);
                    const reportDetails = await response.json();
                    
                    if (reportDetails) {
                        this.updateExistingToastAndModal(data.report_id, reportDetails);
                    }
                } catch (error) {
                    console.error('Error fetching updated report details:', error);
                }
            }
        }
    
        updateExistingToastAndModal(reportId, reportDetails) {
            const modal = document.querySelector(`[data-report-id="${reportId}"]`);
            
            if (modal) {
                const proofImage = modal.querySelector('.proof-image img');
                if (proofImage) {
                    proofImage.src = reportDetails.proof;
                }
    
                const dateElement = modal.querySelector('.info-detail span:first-child');
                const locationElement = modal.querySelector('.info-detail span:nth-child(2)');
                const timeElement = modal.querySelector('.info-detail span:last-child');
    
                if (dateElement) dateElement.textContent = reportDetails.date;
                if (locationElement) locationElement.textContent = reportDetails.where;
                if (timeElement) timeElement.textContent = reportDetails.time;
            }
        }
    
        createToastAndModal(reportDetails) {
            this.toastCounter++;
            
            // Create unique IDs
            const toastId = `dynamic-toast-${this.toastCounter}`;
            const modalId = `dynamic-modal-${this.toastCounter}`;
    
            // Ensure bootstrap is available
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded');
                return;
            }
    
            // Create Toast
            const toastContainer = document.querySelector('.toast-container');
            const newToast = document.createElement('div');
            newToast.className = 'toast';
            newToast.id = toastId;
            newToast.setAttribute('data-report-id', reportDetails.id);
            newToast.setAttribute('role', 'alert');
            newToast.setAttribute('aria-live', 'assertive');
            newToast.setAttribute('aria-atomic', 'true');
            
            newToast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">A Fire has been Detected!</strong>
                    <small class="text-muted">just now</small>
                </div>
                <div class="toast-body">
                    <button class="btn tb-btn" data-bs-toggle="modal" data-bs-target="#${modalId}"  aria-label="Close">
                        View Details <i class="bi bi-arrow-right-circle"></i>
                    </button>
                </div>
            `;
            toastContainer.appendChild(newToast);
    
            // Create Modal
            const modalContainer = document.querySelector('.modal-container');
            const newModal = document.createElement('div');
            newModal.innerHTML = `
            <div class="modal fade custom-modal" id="${modalId}" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" data-report-id="${reportDetails.id}">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="44" height="43" viewBox="0 0 44 43" fill="none">
                                    <path d="M8.97897 26.875V25.0834H7.1873V21.5H8.97897V19.7084H12.5623V26.875H8.97897ZM34.0623 21.5V19.7084H30.479V26.875H34.0623V25.0834H35.854V21.5H34.0623ZM32.2706 10.75H28.4365C27.7915 8.24171 25.8206 6.27087 23.3123 5.62587V3.58337H19.729V5.62587C17.2206 6.27087 15.2498 8.24171 14.6048 10.75H10.7706V14.3334H32.2706V10.75ZM32.2706 39.4167H10.7706C10.7706 37.4459 12.3831 35.8334 14.354 35.8334V16.125H28.6873V35.8334C29.6377 35.8334 30.5491 36.2109 31.2211 36.8829C31.8931 37.5549 32.2706 38.4664 32.2706 39.4167ZM17.9373 23.2917C17.9373 24.2421 18.3148 25.1535 18.9868 25.8255C19.6588 26.4975 20.5703 26.875 21.5206 26.875C22.471 26.875 23.3824 26.4975 24.0544 25.8255C24.7264 25.1535 25.104 24.2421 25.104 23.2917C25.104 21.303 23.5094 19.7084 21.5206 19.7084C19.5319 19.7084 17.9373 21.3209 17.9373 23.2917Z" fill="#ED7027"/>
                                </svg>Alert!
                            </h3>
                        </div>
                        <div class="modal-body">
                            <h4>The System Detected a Fire!</h4>
                            <div class="group-report">
                                <div class="indiv-detail">
                                    <div>Proof</div>
                                    <span class="proof-image">
                                        <img src="${reportDetails.proof}" id="detect-proof-${this.toastCounter}" class="img-fluid" style="max-width: 350px;" alt="Proof Image">
                                    </span>
                                </div>
                                <div class="indiv-detail">
                                    <div class="label-detail">
                                        <div>Date</div>
                                        <div>Location</div>
                                    </div>
                                    <div class="info-detail">
                                        <span>${reportDetails.date}</span>
                                        <span>${reportDetails.where}</span>
                                    </div>
                                </div>
                                <div class="indiv-detail">
                                    <div class="label-detail">
                                        <div>Time</div>
                                    </div>
                                    <div class="info-detail">
                                        <span>${reportDetails.time}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="mf-button">
                                <button type="button" class="btn dismiss-btn" aria-label="Close">Dismiss</button>
                                <button type="button" class="btn report-btn" id="btn-popreport-${this.toastCounter}">Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            // Append modal to body
            modalContainer.appendChild(newModal);
            console.log(newModal.firstChild);

            // Initialize Bootstrap components
            const toastElement = document.getElementById(toastId);
                if (toastElement && bootstrap.Toast) {
                    new bootstrap.Toast(toastElement, {
                        autohide: false
                    }).show();
                }
    
            // Initialize Modal
            const modalElement = document.getElementById(modalId);
            if (modalElement && bootstrap.Modal) {
                new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
            }
        }
    }

    try {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Ensure Bootstrap is loaded
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap is not loaded');
            return;
        }

        const response = await fetch('/get-unresolved-reports/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });

        const unresolvedReports = await response.json();

        // Create a global instance of DesktopUpdates
        window.desktopUpdates = new DesktopUpdates();

        // Create toasts and modals for unresolved reports
        unresolvedReports.forEach(reportDetails => {
            window.desktopUpdates.createToastAndModal(reportDetails);
        });
    } catch (error) {
        console.error('Error fetching unresolved reports:', error);
    }

    // Initialize the class after DOM is loaded
    // const desktopUpdates = new DesktopUpdates();
});
</script>

    
    {%block scripts%}
    <!-- DO NOT ADD SCRIPTS HERE -->
    {%endblock%}

</body>
</html>